###############################################################################
#
# Calculate soil water content and soil k_ratio
#
###############################################################################
"""
    soil_rwc(sh::BrooksCorey{FT}, p_25::FT) where {FT<:AbstractFloat}
    soil_rwc(sh::VanGenuchten{FT}, p_25::FT) where {FT<:AbstractFloat}

Returns the Relative water content of the soil, given
- `sh` [`BrooksCorey`](@ref) ot [`VanGenuchten`](@ref) type soil hydraulics
- `p_25` Matrix water potential equivalent to 25 degree C, with surface tension
correction
"""
function soil_rwc(
            sh::BrooksCorey{FT},
            p_25::FT
) where {FT<:AbstractFloat}
    if p_25 < 0
        @unpack b, ϕs = sh;

        return (-ϕs/p_25) ^ (1/b)
    else
        return FT(1)
    end
end




function soil_rwc(
            sh::VanGenuchten{FT},
            p_25::FT
) where {FT<:AbstractFloat}
    if p_25 < 0
        @unpack m, n, α = sh;

        return ( 1 / ( 1 + (-p_25 * α) ^ n ) ) ^ m
    else
        return FT(1)
    end
end




"""
    soil_k_ratio_rwc(sh::BrooksCorey{FT}, rwc::FT) where {FT<:AbstractFloat}
    soil_k_ratio_rwc(sh::VanGenuchten{FT}, rwc::FT) where {FT<:AbstractFloat}

Return the soil k relative to maximal k, given
- `sh` [`BrooksCorey`](@ref) ot [`VanGenuchten`](@ref) type soil hydraulics
- `rwc` Relative soil water content
"""
function soil_k_ratio_rwc(sh::BrooksCorey{FT}, rwc::FT) where {FT<:AbstractFloat}
    k_ratio = rwc ^ (2*sh.b+3);

    return max(k_ratio, FT(1e-20))
end




function soil_k_ratio_rwc(sh::VanGenuchten{FT}, rwc::FT) where {FT<:AbstractFloat}
    @unpack m = sh;
    k_ratio = sqrt(rwc) * (1 - (1 - rwc^(1/m)) ^ m)^2;

    return max(k_ratio, FT(1e-20))
end




"""
    soil_k_ratio_p25(sh::AbstractSoilVC{FT}, p_25::FT) where {FT<:AbstractFloat}

Return the soil k relative to maximal k, given
- `sh` [`BrooksCorey`](@ref) ot [`VanGenuchten`](@ref) type soil hydraulics
- `p_25` Matrix water potential equivalent to 25 degree C, with surface tension
"""
function soil_k_ratio_p25(sh::AbstractSoilVC{FT}, p_25::FT) where {FT<:AbstractFloat}
    rwc = soil_rwc(sh, p_25);

    return soil_k_ratio_rwc(sh, rwc)
end




"""
    soil_p_25(sh::BrooksCorey{FT}, rwc::FT) where {FT<:AbstractFloat}
    soil_p_25(sh::VanGenuchten{FT}, rwc::FT) where {FT<:AbstractFloat}

Returns the Relative water content of the soil, given
- `sh` [`BrooksCorey`](@ref) ot [`VanGenuchten`](@ref) type soil hydraulics
- `rwc` Relative soil water content

Note that this function returns the matrix potential of water, not water
potential. Also, the potential is that at 25 degree C, not yet been corrected
for temperature effect on surface tension.
"""
function soil_p_25(
            sh::BrooksCorey{FT},
            rwc::FT
) where {FT<:AbstractFloat}
    if rwc < 1
        @unpack b, ϕs = sh;

        return -ϕs / (rwc ^ b)
    else
        return FT(0)
    end
end




function soil_p_25(
            sh::VanGenuchten{FT},
            rwc::FT
) where {FT<:AbstractFloat}
    if rwc < 1
        @unpack m, n, α = sh;

        return -1 * (rwc ^ (-1/m) - 1) ^ (1/n) / α
    else
        return FT(0)
    end
end
